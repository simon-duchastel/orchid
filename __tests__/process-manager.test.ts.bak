/**
 * Tests for process-manager.ts module
 * Simplified tests that focus on core functionality
 */

import {
  getRunningPid,
  isRunning,
  getStatus,
} from '../src/process-manager';

// Mock process.kill for testing process existence
const mockProcessKill = jest.fn();
Object.defineProperty(process, 'kill', {
  value: mockProcessKill,
  writable: true,
});

describe('process-manager.ts - Core Functions', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  describe('getStatus', () => {
    it('should return status with stopped daemon when no PID file exists', () => {
      // Mock file system to return no PID file
      jest.doMock('fs', () => ({
        existsSync: jest.fn().mockReturnValue(false),
      }));

      // Re-import after mocking
      const { getStatus } = require('../src/process-manager');
      const status = getStatus();

      expect(status.running).toBe(false);
      expect(status.pid).toBeNull();
      expect(status.serverUrl).toBeNull();
    });

    it('should return status structure with correct properties', () => {
      const status = getStatus();

      // Should have all required properties
      expect(status).toHaveProperty('running');
      expect(status).toHaveProperty('pid');
      expect(status).toHaveProperty('serverUrl');

      // Values should be of correct type
      expect(typeof status.running).toBe('boolean');
      expect(status.pid === null || typeof status.pid === 'number').toBe(true);
      expect(status.serverUrl === null || typeof status.serverUrl === 'string').toBe(true);
    });
  });

  describe('isRunning', () => {
    it('should be a function', () => {
      expect(typeof isRunning).toBe('function');
    });

    it('should return boolean', () => {
      const running = isRunning();
      expect(typeof running).toBe('boolean');
    });
  });

  describe('getRunningPid', () => {
    it('should be a function', () => {
      expect(typeof getRunningPid).toBe('function');
    });

    it('should return null or number', () => {
      const pid = getRunningPid();
      expect(pid === null || typeof pid === 'number').toBe(true);
    });
  });

  describe('Integration', () => {
    it('should have consistent behavior between functions', () => {
      const pid = getRunningPid();
      const running = isRunning();
      const status = getStatus();

      // Consistency checks
      expect(running).toBe(pid !== null);
      expect(status.running).toBe(running);
      expect(status.pid).toBe(pid);

      // Server URL should be null when not running
      if (!running) {
        expect(status.serverUrl).toBeNull();
      }
    });
  });
});